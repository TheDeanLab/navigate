<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Write A Smart Acquisition Routine (Intermediate) &mdash; navigate 0.0.5 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Write a Custom Plugin (Expert)" href="advanced.html" />
    <link rel="prev" title="Acquire an Image (Beginner)" href="beginner.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            navigate
              <img src="_static/mic.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="quick_start.html">Quick Start Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="implementations/implementations.html">Example Microscopes</a></li>
<li class="toctree-l1"><a class="reference internal" href="software_installation.html">Software Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="i_want_to.html">I Want To…</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="beginner.html">Acquire an Image (Beginner)</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Write A Smart Acquisition Routine (Intermediate)</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced.html">Write a Custom Plugin (Expert)</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="user_guide/hardware_overview.html">Supported Hardware</a></li>
<li class="toctree-l1"><a class="reference internal" href="user_guide/file_formats.html">Supported File Formats</a></li>
<li class="toctree-l1"><a class="reference internal" href="user_guide/gui_walkthrough.html">User Interface Walkthrough</a></li>
<li class="toctree-l1"><a class="reference internal" href="user_guide/setup_microscope.html">Setting Up A Microscope</a></li>
<li class="toctree-l1"><a class="reference internal" href="user_guide/acquiring_home.html">Acquiring Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="user_guide/case_studies/case_studies_home.html">Case Studies</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="contributing/software_architecture.html">Software Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing/contributing_guidelines.html">Contributing Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing/feature_container.html">Feature Container</a></li>
<li class="toctree-l1"><a class="reference internal" href="user_guide/restapi.html">REST-API</a></li>
<li class="toctree-l1"><a class="reference internal" href="plugin/plugin_home.html">Plugin Architecture</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="api.html">API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">navigate</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="i_want_to.html">I Want To…</a></li>
      <li class="breadcrumb-item active">Write A Smart Acquisition Routine (Intermediate)</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/intermediate.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="write-a-smart-acquisition-routine-intermediate">
<h1>Write A Smart Acquisition Routine (Intermediate)<a class="headerlink" href="#write-a-smart-acquisition-routine-intermediate" title="Permalink to this heading"></a></h1>
<p><strong>navigate</strong>’s <a class="reference internal" href="contributing/feature_container.html"><span class="doc">feature container</span></a> enables us to
write acquisition routines on the fly by chaining existing
<a class="reference internal" href="user_guide/features.html"><span class="doc">features</span></a> into lists. Please see
<a class="reference internal" href="contributing/feature_container.html#currently-implemented-features"><span class="std std-ref">Currently Implemented Features</span></a>
for a complete list of features. Users can build additionals feature within <a class="reference internal" href="plugin/plugin_home.html"><span class="doc">plugins</span></a>.</p>
<p>In this guide, we will use existing features to write a routine that scans through an
imaging chamber and takes z-stacks only where it finds the sample.</p>
<p>Suppose there are two positions listed in the
<a class="reference internal" href="user_guide/gui_walkthrough.html#multiposition"><span class="std std-ref">multiposition table</span></a>, one containing
tissue and one empty, as shown below.</p>
<img alt="_images/multiposition_tissue.png" src="_images/multiposition_tissue.png" />
<img alt="_images/multiposition_empty.png" src="_images/multiposition_empty.png" />
<p>We will build a feature that scans both positions, but only takes a z-stack at the one
containing tissue. To access the GUI feature list editor, navigate to
<span class="menuselection">Features ‣ Add Customized Feature List</span>. A window titled “Add New
Feature List” will pop up. Enter <code class="docutils literal notranslate"><span class="pre">TestFeature</span></code> in the text box at the top of the
popup. Enter</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">PrepareNextChannel</span><span class="p">}]</span>
</pre></div>
</div>
<p>in the text box at the bottom of this popup and press <span class="guilabel">Preview</span>. The window
should appear as below.</p>
<img alt="_images/feature_gui_1.png" src="_images/feature_gui_1.png" />
<p>The square brackets <code class="docutils literal notranslate"><span class="pre">[]</span></code> create a sequence of events to run in the feature container.
The <code class="docutils literal notranslate"><span class="pre">{}</span></code> braces contain features. In this case, we have a single feature,
<code class="docutils literal notranslate"><span class="pre">PrepareNextChannel</span></code>, which will set up the next color channel for acquisition. The
complete sequence (as it stands) will take an image in the first
<a class="reference internal" href="user_guide/gui_walkthrough.html#channel-settings"><span class="std std-ref">selected color channel</span></a>.</p>
<p>We can build much of the rest of our desired acquisition in the GUI. Right-click on the
<code class="docutils literal notranslate"><span class="pre">PrepareNextChannel</span></code> tile to reveal the editing menu.</p>
<img alt="_images/feature_gui_2.png" src="_images/feature_gui_2.png" />
<p>Select <span class="guilabel">Insert After</span>. A second copy of <code class="docutils literal notranslate"><span class="pre">PrepareNextChannel</span></code> will appear in
the feature list.</p>
<img alt="_images/feature_gui_3.png" src="_images/feature_gui_3.png" />
<p>Left-click on this second tile to reveal a popup that allows us to
select which feature we want to use in this tile.</p>
<img alt="_images/feature_gui_4.png" src="_images/feature_gui_4.png" />
<p>Select <code class="docutils literal notranslate"><span class="pre">MoveToNextPositionInMultiPositionTable</span></code> and then close the popup. Your
feature list editing window should now appear as below.</p>
<img alt="_images/feature_gui_5.png" src="_images/feature_gui_5.png" />
<p>Our feature now takes one image of the first selected color channel at each position
in the multiposition table.</p>
<p>Now, right-click <code class="docutils literal notranslate"><span class="pre">MoveToNextPositionInMultiPositionTable</span></code> and press
<span class="guilabel">Insert After</span>. Click the new tile and change it to
<code class="docutils literal notranslate"><span class="pre">DetectTissueInStackAndReturn</span></code>. There are three options associated with this feature.</p>
<img alt="_images/feature_gui_6.png" src="_images/feature_gui_6.png" />
<ul class="simple">
<li><p><span class="guilabel">planes</span> indicates how many planes of the z-stack
this feature should check for tissue.</p></li>
<li><p><span class="guilabel">percentage</span> indicates what percent of the total image must contain tissue
for this feature to return <code class="docutils literal notranslate"><span class="pre">true</span></code> that tissue was detected. 1 indicates that the entire
image contains tissue, 0.5 indicates that half of the image contains tissue, and so on.</p></li>
<li><p><span class="guilabel">detect_func</span> is one of the tissue detection functions in
<a class="reference internal" href="_autosummary/navigate.model.features.remove_empty_tiles.html"><span class="doc">remove_empty_tiles</span></a>.
If this is set to <code class="docutils literal notranslate"><span class="pre">None</span></code>, it defaults to <code class="docutils literal notranslate"><span class="pre">detect_tissue()</span></code>, which states that
tissue is present if signal is above the Otsu threshold of the stack of images
acquired.</p></li>
</ul>
<p>In this example, if any plane meets the desired threshold, the feature will return
<code class="docutils literal notranslate"><span class="pre">true</span></code> and it will be acquired. If no plane meets the desired threshold, the feature
will return <code class="docutils literal notranslate"><span class="pre">false</span></code></p>
<p>Now, right-click <code class="docutils literal notranslate"><span class="pre">DetectTissueInStackAndReturn</span></code> and press
<span class="guilabel">Insert After</span>. Click the new tile and change it to
<code class="docutils literal notranslate"><span class="pre">LoopByCount</span></code>.</p>
<img alt="_images/feature_gui_7.png" src="_images/feature_gui_7.png" />
<p>We want to iterate over all of the positions in the multi-position table, so we will
set <code class="docutils literal notranslate"><span class="pre">steps</span></code> to <code class="docutils literal notranslate"><span class="pre">experiment.MicroscopeState.multiposition_count</span></code>.</p>
<p>Notice that the acquisition protocol does not appear to loop, but rather still moves
in a sequence. This is because all of the tiles are still in the sequence brackets
<code class="docutils literal notranslate"><span class="pre">[]</span></code>. We can now enclose the section of the protocol we want to loop in parentheses
<code class="docutils literal notranslate"><span class="pre">()</span></code> and press <span class="guilabel">Preview</span> to see the update.</p>
<img alt="_images/feature_gui_8.png" src="_images/feature_gui_8.png" />
<p>Now, we set up one color channel to image (<code class="docutils literal notranslate"><span class="pre">PrepareNextChannel</span></code>), and then within
this channel visit every position in the multiposition table, and detect if there is
tissue. However, we do no yet make any decisions of what to do if tissue is found.
To do this, we will convert <code class="docutils literal notranslate"><span class="pre">DetectTissueInStackAndReturn</span></code> into a decision node.</p>
<p>To do this, we add <code class="docutils literal notranslate"><span class="pre">true</span></code> and <code class="docutils literal notranslate"><span class="pre">false</span></code> options within the feature braces:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">DetectTissueInStackAndReturn</span><span class="p">,</span>
 <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
 <span class="s2">&quot;true&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">ZStackAcquisition</span><span class="p">,</span><span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="s2">&quot;z-stack&quot;</span><span class="p">,),}],</span>
 <span class="s2">&quot;false&quot;</span><span class="p">:</span> <span class="s2">&quot;continue&quot;</span><span class="p">,}</span>
</pre></div>
</div>
<p>Our <code class="docutils literal notranslate"><span class="pre">true</span></code> argument tells the software what to do if tissue is detected. In this
case, we take a z-stack at the positions where tissue is found. The <code class="docutils literal notranslate"><span class="pre">false</span></code>
argument tells the software how to proceed if no tissue is found. In this case, the
<code class="docutils literal notranslate"><span class="pre">continue</span></code> option tells the software to keep moving through the loop to the next
position in the multi-position table. Press <span class="guilabel">Preview</span> to see the update.</p>
<img alt="_images/feature_gui_9.png" src="_images/feature_gui_9.png" />
<p><code class="docutils literal notranslate"><span class="pre">DetectTissueInStackAndReturn</span></code> now has a red border, indicating it is a decision
node. Click on it to access the decision node GUI.</p>
<img alt="_images/feature_gui_10.png" src="_images/feature_gui_10.png" />
<p>This contains the same settings for <code class="docutils literal notranslate"><span class="pre">DetectTissueInStackAndReturn</span></code> we saw before, but
now also features GUI editing windows for the results of <code class="docutils literal notranslate"><span class="pre">true</span></code> and <code class="docutils literal notranslate"><span class="pre">false</span></code>
decisions arising from this node.</p>
<p>Close the node window and press <span class="guilabel">Add</span> in the “Add New Feature List” window.
This feature is now available under <span class="menuselection">Features ‣ TestFeature</span> and
can be run in “Customized”
<a class="reference internal" href="user_guide/gui_walkthrough.html#acquisition-bar"><span class="std std-ref">acquisition mode</span></a>.</p>
<p>Select “Customized” acquisition mode, select <span class="menuselection">Features ‣ TestFeature</span>,
and press <span class="guilabel">Acquire</span>. For the positions shown at the start of this guide, the
software will go to the first position in the multi-position table, decide there is
tissue present, and take a z-stack. It will then go to the second position in the
multi-position table, find there is no tissue, and decide not to take a z-stack. It
will then exit the loop as no more positions are available in the multi-position table.</p>
<p>Now you can use this feature or build another smart acquisition routine suited to your
microscope’s needs.</p>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="beginner.html" class="btn btn-neutral float-left" title="Acquire an Image (Beginner)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="advanced.html" class="btn btn-neutral float-right" title="Write a Custom Plugin (Expert)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Dean Lab, UT Southwestern Medical Center.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>